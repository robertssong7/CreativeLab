<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drink-ology</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Cocktail Theme: Brighter Midnight Navy & Gold
                        cocktail: {
                            950: '#222c42', // Brighter Midnight Navy (Main BG) - Easier on the eyes
                            900: '#2f3b56', // Lighter Navy (Card BG) - Distinct from BG
                            800: '#404d6e', // Lighter Borders
                            700: '#546387', // Hovers
                            accent: '#e2c070', // Luminous Gold
                            'accent-hover': '#f0d389', 
                            text: '#ffffff', // Pure White for maximum readability
                            muted: '#e2e8f0', // Lighter Slate Gray for secondary text
                        },
                        // Mocktail Theme: Saturated Mediterranean Teal (Kept as requested)
                        mocktail: {
                            50: '#f0fdfa', // Minty White (Main BG)
                            100: '#ccfbf1', // Light Aqua
                            card: '#ffffff', // Clean White
                            accent: '#0d9488', // Deep Saturated Teal
                            'accent-hover': '#115e59', // Darker Teal
                            text: '#134e4a', // Deep Teal/Black
                            muted: '#64748b', // Slate Gray
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for TypeScript/JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar for sidebar */
        .thin-scroll::-webkit-scrollbar { width: 4px; }
        .thin-scroll::-webkit-scrollbar-track { background: transparent; }
        .thin-scroll::-webkit-scrollbar-thumb { background: currentColor; border-radius: 4px; opacity: 0.2; }
        .thin-scroll:hover::-webkit-scrollbar-thumb { opacity: 0.4; }
    </style>
</head>
<body class="transition-colors duration-700">

    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Check = (p) => <Icon {...p}><polyline points="20 6 9 17 4 12" /></Icon>;
        const ChevronRight = (p) => <Icon {...p}><polyline points="9 18 15 12 9 6" /></Icon>;
        const ChevronLeft = (p) => <Icon {...p}><polyline points="15 18 9 12 15 6" /></Icon>;
        const ChevronDown = (p) => <Icon {...p}><polyline points="6 9 12 15 18 9" /></Icon>;
        const Plus = (p) => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></Icon>;
        const RefreshCw = (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></Icon>;
        const Copy = (p) => <Icon {...p}><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></Icon>;
        const Martini = (p) => <Icon {...p}><path d="M8 22h8"/><path d="M12 11v11"/><path d="m19 3-7 8-7-8Z"/></Icon>;
        const Leaf = (p) => <Icon {...p}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 .5 3.5-1.1 9.2A7 7 0 0 1 11 20Z"/><path d="m8 2 1.91 5.74"/></Icon>;
        const Lightbulb = (p) => <Icon {...p}><line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 12 2a4.65 4.65 0 0 0-4.5 9.5c.76.76 1.23 1.52 1.41 2.5"/></Icon>;
        const AlertTriangle = (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;

        // ---------------------------------------------------------------------------
        // Data & Configurations
        // ---------------------------------------------------------------------------
        
        const COCKTAIL_CATEGORIES = [
          { key: "base", title: "Base Spirits", helper: "The foundation.", options: ["Vodka", "Gin", "Rum", "Tequila", "Whiskey"], min: 1 },
          { key: "liqueurs", title: "Modifiers", helper: "Flavor enhancers.", options: ["Amaretto", "Vermouth", "Aperol", "Coffee Liqueur", "Elderflower Liqueur"] },
          { key: "mixers", title: "Mixers", helper: "Lengtheners.", options: ["Club Soda", "Tonic Water", "Cola", "Lemonade", "Sparkling Water"] },
          { key: "juices", title: "Juices", helper: "Acidity.", options: ["Lemon Juice", "Lime Juice", "Orange Juice", "Pineapple Juice", "Cranberry Juice"] },
          { key: "syrups", title: "Syrups", helper: "Balance.", options: ["Simple Syrup", "Agave Syrup", "Grenadine", "Honey Syrup"] },
          { key: "bitters", title: "Bitters", helper: "Complexity.", options: ["Angostura Bitters", "Orange Bitters", "Absinthe"] },
          { key: "essentials", title: "Essentials", helper: "Texture.", options: ["Ice Cubes", "Salt", "Sugar", "Egg Whites"] },
        ];

        const MOCKTAIL_CATEGORIES = [
          { key: "foundation", title: "The Foundation", helper: "Structure & body.", options: ["Green Tea", "Black Tea", "Cold Brew Coffee", "Coconut Water", "Non-Alcoholic Spirit", "Ginger Beer", "Kombucha"], min: 1 },
          { key: "acids", title: "Acids & Shrubs", helper: "The 'Bite'.", options: ["Lemon Juice", "Lime Juice", "Apple Cider Vinegar", "Verjus", "Grapefruit Juice", "Yuzu Juice"] },
          { key: "sweeteners", title: "Sweet & Viscosity", helper: "Texture.", options: ["Simple Syrup", "Honey Syrup", "Agave Syrup", "Maple Syrup", "Grenadine"] },
          { key: "botanicals", title: "Botanicals & Heat", helper: "Nose & spice.", options: ["Fresh Mint", "Fresh Basil", "Rosemary", "Jalapeño", "Ginger", "Cucumber", "Sea Salt"] },
          { key: "lengtheners", title: "The Sparkle", helper: "Effervescence.", options: ["Club Soda", "Tonic Water", "Sparkling Lemonade", "Ginger Ale", "Sparkling Water"] },
        ];

        const NORM = {
          "salt": "Sea Salt", "sea salt": "Sea Salt",
          "soda": "Club Soda", "club soda": "Club Soda",
          "ginger ale": "Ginger Ale", "ginger beer": "Ginger Beer",
          "sparkling lemonade": "Sparkling Lemonade",
          "tea": "Black Tea", "coffee": "Cold Brew Coffee",
          "ice": "Ice Cubes"
        };

        const TAGS = ["Refresher", "Sip", "Punch", "Highball", "Complex", "Spicy", "Tart", "Sweet", "Bitter", "Herbal", "Digestif", "Zero-Proof", "Classic"];

        const RECIPES_DB = {
            cocktail: [
                { name: "Whiskey Sour", tags: ["Classic", "Tart", "Complex"], required: ["Whiskey", "Lemon Juice", "Simple Syrup"], spec: "2 oz whiskey. 1 oz lemon. 1 oz simple. Shake hard, double strain.", tip: "Dry shake (no ice) first if using egg white for extra foam." },
                { name: "Margarita", tags: ["Classic", "Tart"], required: ["Tequila", "Lime Juice", "Agave Syrup"], spec: "2 oz tequila. 1 oz lime. 0.75 oz agave. Shake, strain over fresh ice.", tip: "Use a lime wedge to wet the rim for salt, not water." },
                { name: "Gin & Tonic", tags: ["Highball", "Refresher"], required: ["Gin", "Tonic Water"], spec: "2 oz gin. Build over ice. Top with tonic.", tip: "Pour the tonic down a bar spoon to keep the bubbles alive." },
                { name: "Espresso Martini", tags: ["Modern Classic", "Sweet", "Complex"], required: ["Vodka", "Coffee Liqueur", "Cold Brew Coffee"], spec: "1.5 oz vodka. 1 oz coffee liqueur. 1 oz cold brew. Shake hard.", tip: "Shake until your hands freeze to get that perfect crema foam." },
                { name: "Aperol Spritz", tags: ["Spritz", "Classic"], required: ["Aperol", "Sparkling Water"], spec: "2 oz Aperol. 3 oz Sparkling Water. Splash of Soda. Build in glass over ice.", tip: "Add the sparkling water before the Aperol to prevent it from settling at the bottom." },
                { name: "Manhattan", tags: ["Classic", "Strong"], required: ["Whiskey", "Vermouth", "Angostura Bitters"], spec: "2 oz Whiskey. 1 oz Sweet Vermouth. 2 dashes Bitters. Stir with ice, strain.", tip: "Never shake a Manhattan; stirring preserves the silky texture." }
            ],
            mocktail: [
                { name: "Virgin Mojito", tags: ["Classic Mocktail", "Refresher", "Herbal"], required: ["Fresh Mint", "Lime Juice", "Simple Syrup", "Club Soda"], spec: "Muddle mint lightly. 1 oz lime. 1 oz simple. Shake with ice. Top with soda.", tip: "Clap the mint garnish between your hands to release oils before serving." },
                { name: "Shirley Temple", tags: ["Classic Mocktail", "Sweet"], required: ["Ginger Ale", "Grenadine", "Lime Juice"], spec: "Build in glass. 4 oz ginger ale. 0.5 oz grenadine. Squeeze of lime. Stir.", tip: "Add a splash of soda water to cut the sweetness." },
                { name: "Arnold Palmer", tags: ["Classic Mocktail", "Refresher"], required: ["Black Tea", "Lemon Juice", "Simple Syrup"], spec: "Equal parts iced black tea and lemonade. Build over ice.", tip: "Use cold brew tea for less bitterness." },
                { name: "Spicy Agave Zero", tags: ["Spicy", "Complex"], required: ["Lime Juice", "Agave Syrup", "Jalapeño"], spec: "2 oz water/NA spirit. 1 oz lime. 0.75 oz agave. 2 jalapeño coins. Shake, strain.", tip: "Muddle the seeds of the jalapeño for extra heat." },
                { name: "Cold Brew Tonic", tags: ["Pick-Me-Up", "Bitter"], required: ["Cold Brew Coffee", "Tonic Water"], spec: "Fill glass with ice. 1 part cold brew. 2 parts tonic. Garnish with orange.", tip: "Express an orange peel over the top for aroma." },
                { name: "Gunner", tags: ["Classic Mocktail", "Spicy"], required: ["Ginger Beer", "Ginger Ale", "Lime Juice"], spec: "Equal parts Ginger Beer and Ginger Ale. Squeeze of lime. Stir.", tip: "Add a dash of Angostura bitters if you allow trace alcohol, or use aromatic NA bitters." }
            ]
        };

        // ---------------------------------------------------------------------------
        // Helpers
        // ---------------------------------------------------------------------------
        function titleCase(s) { return s.toLowerCase().split(/\s+/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" "); }
        
        function normalize(item) { 
            const trimmed = item.trim();
            const lower = trimmed.toLowerCase();
            if (NORM[lower]) return NORM[lower];
            return titleCase(trimmed);
        }

        // Returns { valid: boolean, missing: [] }
        function checkIngredients(present, required) {
            const missing = required.filter(r => !present.has(normalize(r)));
            return { valid: missing.length === 0, missing };
        }
        
        function sample(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function maybe(val, chance = 0.5) { return val && Math.random() < chance ? val : undefined; }

        // --- Creative Name Generation ---
        const ADJECTIVES = ["Velvet", "Golden", "Garden", "Dark", "Bright", "Spiced", "Royal", "Wild", "Cool", "Hidden", "Bitter", "Sweet", "Iron"];
        const NOUNS = ["Smash", "Fizz", "Lift", "Sip", "Tonic", "Drift", "Crush", "Sour", "Mule", "Spritz", "Reviver", "Dram"];

        function generateCreativeName(base, ingredients) {
            const adj = sample(ADJECTIVES);
            const noun = sample(NOUNS);
            return `${adj} ${noun}`;
        }

        function getTipForIngredients(ingredients) {
            if (ingredients.some(i => i.includes("Egg"))) return "Dry shake without ice first to emulsify the egg white.";
            if (ingredients.some(i => i.includes("Mint") || i.includes("Basil"))) return "Slap the herbs before garnishing to release the aromatics.";
            if (ingredients.some(i => i.includes("Cucumber"))) return "Double strain to ensure a silky smooth texture without pulp.";
            if (ingredients.some(i => i.includes("Tonic") || i.includes("Soda"))) return "Ensure your carbonated mixer is ice cold for maximum fizz.";
            if (ingredients.some(i => i.includes("Coffee") || i.includes("Brew"))) return "Use plenty of ice to dilute the concentration slightly.";
            if (ingredients.some(i => i.includes("Jalapeño") || i.includes("Ginger"))) return "Adjust the muddle time to control the spice level.";
            return "Chill your glassware beforehand for a pro touch.";
        }

        function generateDrinks(mode, present, count, prompt, filters, existingNames = new Set()) {
            const pool = [];
            const isMock = mode === 'mocktail';
            const db = isMock ? RECIPES_DB.mocktail : RECIPES_DB.cocktail;

            // 1. Classics & Close Calls
            if (filters.classic) {
                const classics = db.map(r => {
                    const check = checkIngredients(present, r.required);
                    let score = 0;
                    if (prompt) {
                        const p = prompt.toLowerCase();
                        if (r.name.toLowerCase().includes(p)) score += 5;
                        if (r.tags.some(t => t.toLowerCase().includes(p))) score += 3;
                    }
                    return { ...r, id: r.name + '::classic', score, missing: check.missing };
                });

                // Filter: Perfect matches OR close matches (missing 1)
                const perfect = classics.filter(c => c.missing.length === 0);
                const close = classics.filter(c => c.missing.length === 1);

                // Sort: Perfect first, then Close
                perfect.sort((a,b) => b.score - a.score);
                close.sort((a,b) => b.score - a.score);

                pool.push(...perfect);
                // If we need padding, add close matches
                if (pool.length < 3) {
                    pool.push(...close);
                }
            }

            // 2. Creative
            if (filters.creative) {
                const creativeCount = Math.max(3, count - pool.length); // Ensure at least a few creative
                const generated = isMock 
                    ? generateMocktailCreative(present, creativeCount * 2, prompt, existingNames)
                    : generateCocktailCreative(present, creativeCount * 2, prompt, existingNames);
                
                // Shuffle generated to ensure variety on regen
                const shuffled = generated.sort(() => 0.5 - Math.random());
                pool.push(...shuffled);
            }

            // Dedup and Limit
            const final = [];
            const seen = new Set();
            for (const r of pool) {
                if (!seen.has(r.name) && !existingNames.has(r.name)) {
                    seen.add(r.name);
                    final.push(r);
                }
                if (final.length >= count) break;
            }
            return final;
        }

        function generateMocktailCreative(present, count, prompt, existingNames) {
            const bases = ["Green Tea", "Black Tea", "Cold Brew Coffee", "Coconut Water", "Non-Alcoholic Spirit", "Kombucha"].filter(b => present.has(b));
            const effectiveBases = bases.length ? bases : (present.has("Club Soda") || present.has("Ginger Beer") ? ["Soda Base"] : []);
            
            if (!effectiveBases.length) return [];

            const pick = (arr) => arr.filter(x => present.has(x));
            const acids = ["Lemon Juice", "Lime Juice", "Apple Cider Vinegar", "Grapefruit Juice"];
            const sweets = ["Simple Syrup", "Honey Syrup", "Agave Syrup", "Grenadine"];
            const botanicals = ["Fresh Mint", "Fresh Basil", "Rosemary", "Jalapeño", "Ginger", "Cucumber"];
            const lengtheners = ["Club Soda", "Tonic Water", "Ginger Beer", "Ginger Ale", "Sparkling Lemonade"];

            const out = [];
            let attempts = 0;
            while(out.length < count && attempts < 100) {
                attempts++;
                const b = effectiveBases[0] === "Soda Base" ? undefined : sample(effectiveBases);
                const a = maybe(sample(pick(acids)), 0.9);
                const s = maybe(sample(pick(sweets)), 0.9);
                const bot = maybe(sample(pick(botanicals)), 0.6);
                const len = maybe(sample(pick(lengtheners)), b ? 0.4 : 1.0);

                if (!b && !len) continue;
                if (!a && !bot && !prompt) continue;

                if (prompt) {
                    const p = prompt.toLowerCase();
                    const ingredients = [b, a, s, bot, len].filter(Boolean).join(" ").toLowerCase();
                    if (p.includes("spicy") && !ingredients.includes("jalapeno") && !ingredients.includes("ginger")) continue;
                    if (p.includes("refresh") && !ingredients.includes("cucumber") && !ingredients.includes("mint") && !ingredients.includes("soda")) continue;
                }

                const name = generateCreativeName(b, [a,s,bot,len]);
                if (existingNames.has(name) || out.some(o => o.name === name)) continue;

                const tags = ["Creative"];
                if (len) tags.push("Highball");
                if (bot) tags.push("Herbal");
                
                let specParts = [];
                if (bot && ["Fresh Mint", "Fresh Basil", "Cucumber", "Rosemary", "Jalapeño"].includes(bot)) specParts.push(`Muddle ${bot.toLowerCase()} lightly`);
                if (b) specParts.push(`2 oz ${b}`);
                if (a) specParts.push(`0.75 oz ${a}`);
                if (s) specParts.push(`0.5 oz ${s}`);
                specParts.push("Shake with ice");
                if (len) specParts.push(`Top with ${len}`); else specParts.push("Strain over fresh ice");

                const allIng = [b,a,s,bot,len].filter(Boolean);
                out.push({
                    id: `gen-m-${Math.random()}`, 
                    name, 
                    tags: tags.slice(0, 3), 
                    spec: specParts.join(". "), 
                    tip: getTipForIngredients(allIng)
                });
            }
            return out;
        }

        function generateCocktailCreative(present, count, prompt, existingNames) {
            const bases = ["Vodka", "Gin", "Rum", "Tequila", "Whiskey"].filter(b => present.has(b));
            if (!bases.length) return [];
            
            const pick = (arr) => arr.filter(x => present.has(x));
            const acids = ["Lemon Juice", "Lime Juice", "Orange Juice"];
            const sweets = ["Simple Syrup", "Agave Syrup", "Grenadine", "Honey Syrup"];
            const mods = ["Vermouth", "Aperol", "Coffee Liqueur", "Angostura Bitters"];
            const fizz = ["Club Soda", "Tonic Water", "Cola"];
            
            const out = [];
            let attempts = 0;
            while(out.length < count && attempts < 100) {
                attempts++;
                const b = sample(bases);
                const a = maybe(sample(pick(acids)), 0.8);
                const s = maybe(sample(pick(sweets)), 0.8);
                const m = maybe(sample(pick(mods)), 0.4);
                const f = maybe(sample(pick(fizz)), 0.3);
                
                if (!a && !m && !f) continue;
                if (prompt) {
                     const p = prompt.toLowerCase();
                     if (p.includes("bitter") && !m?.includes("Bitters") && !m?.includes("Aperol")) continue;
                     if (p.includes("bubb") && !f) continue;
                }

                const name = generateCreativeName(b, []);
                if (existingNames.has(name) || out.some(o => o.name === name)) continue;

                let specParts = [`2 oz ${b}`];
                if (a) specParts.push(`0.75 oz ${a}`);
                if (s) specParts.push(`0.75 oz ${s}`);
                if (m) specParts.push(`0.5 oz ${m}`);
                specParts.push("Shake & Strain");
                if (f) specParts.push(`Top with ${f}`);

                const tags = ["Creative"];
                if (f) tags.push("Highball");
                if (m === "Angostura Bitters") tags.push("Complex");

                const allIng = [b,a,s,m,f].filter(Boolean);

                out.push({
                    id: `gen-c-${Math.random()}`, 
                    name, 
                    tags, 
                    spec: specParts.join(". "), 
                    tip: getTipForIngredients(allIng)
                });
            }
            return out;
        }

        // ---------------------------------------------------------------------------
        // State Logic
        // ---------------------------------------------------------------------------
        function usePantryState(mode) {
            const [pantry, setPantry] = useState({});

            const toggle = (key, item) => {
                const norm = normalize(item);
                setPantry(prev => {
                    const prevSet = prev[key] || new Set();
                    const nextSet = new Set(prevSet);
                    if (nextSet.has(norm)) nextSet.delete(norm);
                    else nextSet.add(norm);
                    return { ...prev, [key]: nextSet };
                });
            };

            const isSelected = (key, displayedOption) => {
                const norm = normalize(displayedOption);
                return pantry[key]?.has(norm) || false;
            };

            const reset = () => setPantry({});
            return { pantry, toggle, isSelected, reset };
        }

        function flattenPantry(pantry) {
            const all = new Set();
            Object.values(pantry).forEach(set => set.forEach(v => all.add(v)));
            return all;
        }

        // ---------------------------------------------------------------------------
        // Main Components
        // ---------------------------------------------------------------------------
        function App() {
            const [mode, setMode] = useState("cocktail");
            const { pantry, toggle, isSelected, reset } = usePantryState(mode);
            const [step, setStep] = useState(0);
            const [results, setResults] = useState([]);
            
            const CONFIG = mode === "cocktail" ? COCKTAIL_CATEGORIES : MOCKTAIL_CATEGORIES;
            const [optionsMap, setOptionsMap] = useState({});

            // Theme colors logic mapping
            const theme = useMemo(() => {
                if (mode === 'mocktail') {
                    return {
                        bg: 'bg-mocktail-50',
                        text: 'text-mocktail-text',
                        accent: 'bg-mocktail-accent hover:bg-mocktail-accent-hover',
                        accentText: 'text-mocktail-accent',
                        card: 'bg-mocktail-card',
                        cardBorder: 'border-black/5',
                        progress: 'bg-mocktail-accent',
                        sidebar: 'bg-white/50 border-black/5',
                        toggleBg: 'bg-gray-200',
                        toggleBtnActive: 'text-mocktail-text',
                        toggleBtnInactive: 'text-gray-400 hover:text-gray-600',
                        slider: 'bg-mocktail-accent'
                    };
                } else {
                    return {
                        bg: 'bg-cocktail-950',
                        text: 'text-cocktail-text',
                        accent: 'bg-cocktail-accent hover:bg-cocktail-accent-hover text-cocktail-950', // Contrast fix: dark text on gold button
                        accentText: 'text-cocktail-accent',
                        card: 'bg-cocktail-900',
                        cardBorder: 'border-cocktail-800',
                        progress: 'bg-cocktail-accent',
                        sidebar: 'bg-cocktail-900/50 border-cocktail-800',
                        toggleBg: 'bg-cocktail-900',
                        toggleBtnActive: 'text-cocktail-text',
                        toggleBtnInactive: 'text-cocktail-muted hover:text-cocktail-text',
                        slider: 'bg-cocktail-accent'
                    };
                }
            }, [mode]);

            useEffect(() => {
                const newMap = {};
                CONFIG.forEach(c => {
                    const defaultOpts = new Set(c.options);
                    if (pantry[c.key]) pantry[c.key].forEach(itm => defaultOpts.add(itm));
                    newMap[c.key] = Array.from(defaultOpts);
                });
                setOptionsMap(newMap);
                setStep(0);
                setResults([]);
            }, [mode]);

            const handleAddOther = (key, raw) => {
                if (!raw.trim()) return;
                const norm = normalize(raw);
                setOptionsMap(prev => ({
                    ...prev,
                    [key]: [...(prev[key] || []), norm]
                }));
                toggle(key, raw);
            };

            const progress = ((step + 1) / (CONFIG.length + 1)) * 100;
            const present = useMemo(() => flattenPantry(pantry), [pantry]);

            const handleGenerate = (prompt, filters) => {
                const existingNames = new Set(results.map(r => r.name));
                const namesToAvoid = results.length > 0 ? existingNames : new Set();
                const drinks = generateDrinks(mode, present, 6, prompt, filters, namesToAvoid);
                setResults(drinks);
                setStep(CONFIG.length);
            };

            return (
                <div className={`min-h-screen transition-colors duration-700 ${theme.bg} ${theme.text}`}>
                    <div className="mx-auto max-w-5xl px-4 py-8">
                        {/* Header */}
                        <header className="flex flex-col items-center justify-center gap-6 pb-8 md:flex-row md:justify-between">
                            <div>
                                <h1 className="text-4xl font-semibold tracking-tight serif italic">Drink-ology</h1>
                                <p className="mt-1 text-sm opacity-60">The science of the perfect sip.</p>
                            </div>
                            <div className={`relative flex items-center rounded-full p-1 shadow-inner transition-colors duration-700 ${theme.toggleBg}`}>
                                <button onClick={() => setMode('cocktail')} className={`relative z-10 flex w-32 items-center justify-center gap-2 rounded-full py-2 text-sm font-medium transition-all duration-300 ${mode === 'cocktail' ? 'text-cocktail-950' : theme.toggleBtnInactive}`}>
                                    <Martini className="h-4 w-4" /> Cocktail
                                </button>
                                <button onClick={() => setMode('mocktail')} className={`relative z-10 flex w-32 items-center justify-center gap-2 rounded-full py-2 text-sm font-medium transition-all duration-300 ${mode === 'mocktail' ? 'text-white' : theme.toggleBtnInactive}`}>
                                    <Leaf className="h-4 w-4" /> Mocktail
                                </button>
                                <div className={`absolute top-1 bottom-1 w-32 rounded-full shadow-md transition-transform duration-500 ${theme.slider} ${mode === 'mocktail' ? 'translate-x-32' : 'translate-x-0'}`} />
                            </div>
                        </header>

                        {/* Progress */}
                        <div className={`h-1.5 w-full overflow-hidden rounded-full ${mode === 'mocktail' ? 'bg-black/5' : 'bg-white/10'}`}>
                            <div className={`h-full transition-all duration-500 ease-out ${theme.progress}`} style={{ width: `${progress}%` }} />
                        </div>

                        <main className="mt-8 grid grid-cols-1 gap-8 md:grid-cols-12 fade-in">
                            <section className="md:col-span-8">
                                {step < CONFIG.length ? (
                                    <CategoryCard 
                                        cat={CONFIG[step]}
                                        stepIndex={step}
                                        totalSteps={CONFIG.length}
                                        options={optionsMap[CONFIG[step].key] || []}
                                        isSelected={(opt) => isSelected(CONFIG[step].key, opt)}
                                        onToggle={(opt) => toggle(CONFIG[step].key, opt)}
                                        onAddOther={(raw) => handleAddOther(CONFIG[step].key, raw)}
                                        onNext={() => setStep(s => Math.min(s+1, CONFIG.length))}
                                        onPrev={step > 0 ? () => setStep(s => s-1) : null}
                                        mode={mode}
                                        theme={theme}
                                    />
                                ) : (
                                    <GenerateCard 
                                        onGenerate={handleGenerate}
                                        results={results}
                                        onReset={() => { setStep(0); setResults([]); }}
                                        mode={mode}
                                        theme={theme}
                                    />
                                )}
                            </section>

                            <Sidebar 
                                mode={mode} 
                                pantry={pantry} 
                                config={CONFIG} 
                                currentStep={step} 
                                onJumpTo={setStep}
                                onGenerate={() => handleGenerate("", {classic: true, creative: true})}
                                theme={theme}
                            />
                        </main>
                    </div>
                </div>
            );
        }

        function CategoryCard({ cat, stepIndex, totalSteps, options, isSelected, onToggle, onAddOther, onNext, onPrev, mode, theme }) {
            const [otherVal, setOtherVal] = useState("");
            
            // Dynamic Classes for buttons and inputs based on theme
            const activeClass = mode === 'mocktail' 
                ? 'border-mocktail-accent bg-mocktail-50 text-mocktail-accent font-semibold shadow-sm' 
                : 'border-cocktail-accent bg-cocktail-950 text-cocktail-accent font-semibold shadow-sm';
            
            const inactiveClass = mode === 'mocktail'
                ? 'border-black/10 bg-white hover:bg-mocktail-50 hover:border-mocktail-accent/30 text-mocktail-text'
                : 'border-cocktail-800 bg-cocktail-900/50 hover:bg-cocktail-800 hover:border-cocktail-700 text-cocktail-muted';

            const inputClass = mode === 'mocktail'
                ? 'border-black/10 bg-transparent text-mocktail-text focus:border-mocktail-accent'
                : 'border-cocktail-700 bg-cocktail-950/50 text-cocktail-text focus:border-cocktail-accent placeholder-cocktail-muted/50';
            
            const btnIconClass = mode === 'mocktail' ? 'border-black/10 hover:bg-mocktail-50' : 'border-cocktail-700 hover:bg-cocktail-800 text-cocktail-muted hover:text-cocktail-text';

            return (
                <div className={`fade-in rounded-3xl border p-6 shadow-xl md:p-10 ${theme.card} ${theme.cardBorder}`}>
                    <div className="mb-6 flex items-start justify-between">
                        <div>
                            <h2 className="serif text-3xl mb-1">{cat.title}</h2>
                            <p className="text-sm opacity-60 max-w-md">{cat.helper}</p>
                        </div>
                        <div className="text-xs font-mono uppercase tracking-widest opacity-40">Step {stepIndex + 1}/{totalSteps + 1}</div>
                    </div>

                    <div className="mb-8 flex flex-col gap-2">
                        {options.map(opt => {
                            const active = isSelected(opt);
                            return (
                                <button 
                                    key={opt}
                                    onClick={() => onToggle(opt)}
                                    className={`group flex items-center justify-between rounded-xl border px-4 py-3 text-left text-sm transition-all duration-200 ${active ? activeClass : inactiveClass}`}
                                >
                                    <span>{opt}</span>
                                    {active ? <Check className="h-4 w-4" /> : <div className={`h-4 w-4 rounded-full border ${mode === 'mocktail' ? 'border-black/10' : 'border-cocktail-700'}`}></div>}
                                </button>
                            );
                        })}
                    </div>

                    <div className={`mb-8 border-t pt-4 ${mode === 'mocktail' ? 'border-black/5' : 'border-cocktail-800'}`}>
                        <div className="flex items-center gap-2">
                            <input 
                                value={otherVal}
                                onChange={e => setOtherVal(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && (onAddOther(otherVal), setOtherVal(""))}
                                placeholder={`Add custom ${cat.title.toLowerCase()}...`}
                                className={`flex-1 rounded-xl border px-4 py-3 text-sm outline-none ${inputClass}`}
                            />
                            <button onClick={() => {onAddOther(otherVal); setOtherVal("");}} className={`rounded-xl border p-3 ${btnIconClass}`}>
                                <Plus className="h-4 w-4" />
                            </button>
                        </div>
                    </div>

                    <div className="flex items-center justify-between pt-2">
                        {onPrev ? (
                            <button onClick={onPrev} className={`flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium hover:underline opacity-60 hover:opacity-100`}>
                                <ChevronLeft className="h-4 w-4" /> Back
                            </button>
                        ) : <span />}
                        <button onClick={onNext} className={`flex items-center gap-2 rounded-xl px-6 py-3 text-sm font-medium shadow-lg transition-transform hover:-translate-y-0.5 active:translate-y-0 ${theme.accent} ${mode === 'mocktail' ? 'text-white' : 'text-cocktail-950'}`}>
                            Next Step <ChevronRight className="h-4 w-4" />
                        </button>
                    </div>
                </div>
            );
        }

        function GenerateCard({ onGenerate, results, onReset, mode, theme }) {
            const [prompt, setPrompt] = useState("");
            const [filters, setFilters] = useState({ classic: true, creative: true });
            const [expandedId, setExpandedId] = useState(null);

            useEffect(() => {
                onGenerate("", { classic: true, creative: true });
            }, []);

            const handleRegen = (overrideFilters) => {
                setExpandedId(null);
                onGenerate(prompt, overrideFilters || filters);
            };

            const toggleExpand = (id) => setExpandedId(curr => curr === id ? null : id);
            
            // Text colors for details - ENSURING READABILITY
            // For cocktail mode, we use pure off-white for text, on a darker background than the card
            const detailText = mode === 'mocktail' ? 'text-mocktail-text' : 'text-cocktail-text'; 
            const detailBg = mode === 'mocktail' ? 'bg-mocktail-50' : 'bg-cocktail-950/40';
            const inputBg = mode === 'mocktail' ? 'bg-white' : 'bg-cocktail-950/50 border-cocktail-700 text-cocktail-text';
            const itemHover = mode === 'mocktail' ? 'hover:border-mocktail-accent/50' : 'hover:border-cocktail-accent/50';

            return (
                <div className={`fade-in rounded-3xl border p-6 shadow-xl md:p-10 ${theme.card} ${theme.cardBorder}`}>
                    <div className="mb-6 text-center">
                        <Sparkles className={`mx-auto mb-4 h-8 w-8 ${theme.accentText}`} />
                        <h2 className="serif text-3xl mb-2">Your Menu</h2>
                        <p className="text-sm opacity-60">Curated based on your inventory.</p>
                    </div>

                    {/* House Tip */}
                    <div className={`mb-6 flex gap-3 rounded-lg border p-4 text-sm ${mode === 'mocktail' ? 'border-mocktail-accent/20 bg-mocktail-50 text-mocktail-text' : 'border-cocktail-700 bg-cocktail-800/30 text-cocktail-text'}`}>
                        <Lightbulb className="h-5 w-5 shrink-0 opacity-80" />
                        <p><span className="font-bold">House Rule:</span> Always chill your glassware before serving. A cold glass keeps the drink alive longer.</p>
                    </div>

                    {/* Drink List */}
                    <div className="mb-8 space-y-3">
                        {results.length > 0 ? results.map((r, i) => {
                            const isMissing = r.missing && r.missing.length > 0;
                            return (
                                <div key={r.id} className={`overflow-hidden rounded-xl border transition-all duration-300 ${expandedId === r.id ? 'shadow-md border-current' : 'border-transparent hover:border-current'} ${itemHover}`}>
                                    <button 
                                        onClick={() => toggleExpand(r.id)}
                                        className={`flex w-full items-center justify-between p-4 text-left ${mode === 'mocktail' ? 'bg-white' : 'bg-cocktail-800/50'}`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-xs font-bold ${mode === 'mocktail' ? 'bg-mocktail-100 text-mocktail-accent' : 'bg-cocktail-950 text-cocktail-accent'}`}>{i + 1}</div>
                                            <div>
                                                <div className="font-serif font-medium text-lg flex items-center gap-2">
                                                    {r.name}
                                                    {isMissing && <span className="rounded bg-red-100 px-1.5 py-0.5 text-[10px] font-bold uppercase tracking-wide text-red-700">Missing 1</span>}
                                                </div>
                                                <div className="flex gap-2 text-[10px] uppercase tracking-wider opacity-60">
                                                    {r.tags.map(t => <span key={t}>{t}</span>)}
                                                </div>
                                            </div>
                                        </div>
                                        <ChevronDown className={`h-4 w-4 transition-transform ${expandedId === r.id ? 'rotate-180' : ''}`} />
                                    </button>
                                    
                                    {expandedId === r.id && (
                                        <div className={`p-6 border-t animate-fadeIn ${detailBg} ${mode === 'mocktail' ? 'border-mocktail-100' : 'border-cocktail-700'}`}>
                                            {isMissing && (
                                                <div className="mb-4 flex items-center gap-2 text-xs text-red-500 font-medium">
                                                    <AlertTriangle className="h-4 w-4" />
                                                    <span>Missing: {r.missing.join(", ")}</span>
                                                </div>
                                            )}
                                            
                                            {/* Vertical Spec Layout */}
                                            <div className="mb-6 space-y-4">
                                                <div>
                                                    <h4 className="mb-2 text-xs font-bold uppercase tracking-widest opacity-50">Ingredients</h4>
                                                    <ul className={`list-disc pl-4 text-sm leading-relaxed ${detailText}`}>
                                                        {r.spec.split('.').map(s => s.trim()).filter(Boolean).map((line, idx) => (
                                                            <li key={idx} className="pl-1">{line}</li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            </div>

                                            {r.tip && (
                                                <div className={`flex gap-3 rounded-lg border p-3 text-sm ${mode === 'mocktail' ? 'border-mocktail-accent/20 bg-white text-mocktail-text' : 'border-cocktail-accent/30 bg-cocktail-900 text-cocktail-text'}`}>
                                                    <Lightbulb className={`h-5 w-5 shrink-0 opacity-80 ${theme.accentText}`} />
                                                    <p><span className="font-bold">Pro Tip:</span> {r.tip}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        }) : (
                            <div className="py-8 text-center opacity-50 text-sm">No drinks match. Try adding more ingredients.</div>
                        )}
                    </div>

                    {/* Controls & Regeneration */}
                    <div className={`space-y-4 rounded-2xl p-6 ${mode === 'mocktail' ? 'bg-mocktail-50' : 'bg-cocktail-900/50 border border-cocktail-800'}`}>
                        <div className="space-y-2">
                            <label className="text-xs font-bold uppercase tracking-widest opacity-50">Custom Request</label>
                            <input 
                                value={prompt}
                                onChange={e => setPrompt(e.target.value)}
                                placeholder="E.g., 'spicy', 'refreshing', 'fruity'..."
                                className={`w-full rounded-xl border px-4 py-3 text-sm outline-none focus:border-current ${inputBg}`}
                            />
                        </div>
                        
                        <div className="flex flex-wrap gap-2 text-xs">
                            <label className={`flex cursor-pointer items-center gap-2 rounded-lg border px-3 py-2 ${inputBg}`}>
                                <input type="checkbox" checked={filters.classic} onChange={e => setFilters(p => ({...p, classic: e.target.checked}))} /> Classics
                            </label>
                            <label className={`flex cursor-pointer items-center gap-2 rounded-lg border px-3 py-2 ${inputBg}`}>
                                <input type="checkbox" checked={filters.creative} onChange={e => setFilters(p => ({...p, creative: e.target.checked}))} /> Creative
                            </label>
                        </div>

                        <div className="flex flex-col gap-3 pt-2 sm:flex-row">
                             <button onClick={() => handleRegen()} className={`flex-1 rounded-xl border border-current px-4 py-3 text-sm font-medium hover:opacity-80`}>Regenerate Menu</button>
                             <button onClick={onReset} className="rounded-xl border border-red-500/30 px-4 py-3 text-sm font-medium text-red-500 hover:bg-red-500/10">Reset</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Sidebar({ mode, pantry, config, currentStep, onJumpTo, onGenerate, theme }) {
            return (
                <aside className={`h-fit sticky top-4 md:col-span-4 rounded-2xl border p-6 shadow-sm backdrop-blur-sm ${theme.sidebar}`}>
                    <div className={`mb-4 flex items-center justify-between border-b pb-2 ${mode === 'mocktail' ? 'border-black/5' : 'border-cocktail-800'}`}>
                        <h3 className="serif text-lg italic">Your Bar</h3>
                        <span className="text-xs uppercase tracking-wider opacity-50">{mode} Pantry</span>
                    </div>
                    
                    <div className="mb-6 space-y-4 max-h-[60vh] overflow-y-auto thin-scroll pr-2">
                        {config.map((c, idx) => {
                            const items = pantry[c.key] ? Array.from(pantry[c.key]) : [];
                            if (items.length === 0 && currentStep !== idx) return null;
                            const isActive = currentStep === idx;
                            return (
                                <div key={c.key} className={`transition-opacity ${isActive ? 'opacity-100' : 'opacity-60 hover:opacity-100'}`}>
                                    <button onClick={() => onJumpTo(idx)} className="mb-1 flex w-full items-center justify-between text-left text-sm font-medium hover:underline">
                                        <span>{c.title}</span>
                                        <span className="text-xs opacity-50">{items.length}</span>
                                    </button>
                                    <div className="flex flex-wrap gap-1.5">
                                        {items.map(v => (
                                            <span key={v} className={`rounded-md border px-1.5 py-0.5 text-[10px] ${mode === 'mocktail' ? 'border-mocktail-accent/30 bg-mocktail-50 text-mocktail-accent' : 'border-cocktail-700 bg-cocktail-950 text-cocktail-muted'}`}>
                                                {v}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <button 
                        onClick={onGenerate} 
                        className={`w-full flex items-center justify-center gap-2 rounded-xl py-3 text-sm font-medium shadow-lg transition-transform hover:-translate-y-0.5 active:translate-y-0 ${theme.accent} ${mode === 'mocktail' ? 'text-white' : 'text-cocktail-950'}`}
                    >
                        <Sparkles className="h-4 w-4" /> Generate Menu
                    </button>
                </aside>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
